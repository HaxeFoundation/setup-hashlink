name: continuous-integration
on: push

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch sources
        uses: actions/checkout@v4
      - name: Set up Haxe
        uses: krdlab/setup-haxe@v2
        with:
          haxe-version: 5.0.0-preview.1
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: npm
          node-version: latest
      - name: Cache haxelib dependencies
        id: haxelib-cache
        uses: actions/cache@v4
        with:
          path: .haxelib
          key: haxe-${{runner.os}}-${{hashFiles('install.hxml')}}
      - name: Install haxelib dependencies
        if: steps.haxelib-cache.outputs.cache-hit != 'true'
        run: |
          haxelib newrepo
          haxelib state load install.hxml
      - name: Install npm dependencies
        run: npm ci
      - name: Run tests
        run: haxe test.hxml
  run:
    needs: test
    runs-on: ${{matrix.platform}}
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]
        hl: [nightly, latest, 1.14.0]
        exclude:
          - platform: macos-latest
            hl: 1.14.0
          - platform: macos-latest
            hl: latest
    steps:
      - uses: HaxeFoundation/setup-hashlink@v1
        with:
          version: ${{matrix.hl}}
      - run: hl --version
